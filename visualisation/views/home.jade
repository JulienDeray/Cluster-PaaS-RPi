html
  head
    title=title
    link(href='//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css', rel='stylesheet')
  body
    div.container
      div.jumbotron
        h1 Cluster informations

      h2#alone.hidden.alert #{ip} is the only node connected at this moment !

      table.table.table-striped
        thead
            tr
                th IP
                th Port
                th Name
                th Suspicion level
        tbody#nodes

    script(src='/socket.io/socket.io.js')
    script(src='http://code.jquery.com/jquery-2.1.4.min.js')
    script(type='text/javascript').
        var socket = io.connect("#{ip}:8080");

        function updatePeerInfos(peerInfos) {
            console.log('new peer informations received', JSON.stringify(peerInfos));

            var state;
            if (peerInfos.ip == '#{ip}') {
                state = stateLabel(true, "Self");
            }
            else {
                state = stateLabel(peerInfos.state, 'Unknown');
            }

            var peer_tr = $('#' + peerInfos.name);
            if ( peer_tr.length > 0 ) {
                peer_tr.find('.ip').first().html(peerInfos.ip);
                peer_tr.find('.port').first().html(peerInfos.port);
                peer_tr.find('.name').first().html(peerInfos.name);
                peer_tr.find('.state').first().html(state);
            }
            else {
                $('#nodes').append(
                        '<tr id="' + peerInfos.name + '">' +
                        '<td class="ip">' + peerInfos.ip + '</td>' +
                        '<td class="port">' + peerInfos.port + '</td>' +
                        '<td class="name">' + peerInfos.name + '</td>' +
                        '<td class="state">' + state + '</td>' +
                        '</tr>'
                );
            }
        }

        function stateLabel(state, suspicionLevel) {
            if (state) {
                return '<span class="label label-success">' + suspicionLevel + '</span>';
            }
            else {
                return '<span class="label label-danger">' + suspicionLevel + '</span>';
            }
        }

        function changePeerState(peerName, state, suspicionLevel) {
            var peer_tr = $('#' + peerName);
            peer_tr.find('.state').first().html(stateLabel(state, suspicionLevel));
        }

        function computeSuspicionLevel(peerObj) {
            const ratio = (peerObj.phi / peerObj.threshold) * 100;
            return ratio.toFixed(0);
        }

        socket.on('new_peer', function(peerInfos) {
            updatePeerInfos(peerInfos);
        });

        socket.on('update', function(peerInfos) {
            updatePeerInfos(peerInfos);
        });


        socket.on('peer_failed', function(peerObj) {
            console.log('peer', peerObj.name, 'failed !');
            var suspicionLevel = computeSuspicionLevel(peerObj) + '%';
            changePeerState(peerObj.name, false, suspicionLevel);
        });

        socket.on('peer_alive', function (peerObj) {
            console.log('peer', peerObj.name, 'alive !');
            var suspicionLevel = computeSuspicionLevel(peerObj) + '%';
            changePeerState(peerObj.name, true, suspicionLevel);
        });

        socket.on('alone', function(isAlone) {
            if (isAlone) {
                $('#alone').removeClass('hidden').addClass('show');
            }
            else {
                $('#alone').removeClass('show').addClass('hidden');
            }
        });